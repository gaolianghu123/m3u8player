<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M3U8 转 MP4 在线转换器</title>
    <!-- 预加载所有资源，通过代理 -->
    <link rel="preload" href="/wasm/@ffmpeg/core@0.12.6/dist/umd/ffmpeg-core.wasm" as="fetch" type="application/wasm" crossorigin="anonymous">
    <link rel="preload" href="/wasm/@ffmpeg/ffmpeg@0.12.10/dist/umd/ffmpeg.js" as="script" crossorigin="anonymous">
    <script src="/wasm/@ffmpeg/ffmpeg@0.12.10/dist/umd/ffmpeg.js" crossorigin="anonymous"></script>  <!-- 加 crossorigin -->
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; }
        input { width: 100%; padding: 10px; margin-bottom: 10px; box-sizing: border-box; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; cursor: pointer; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        #status { margin: 10px 0; color: #666; }
        #progress { width: 100%; height: 20px; background: #f0f0f0; border-radius: 10px; overflow: hidden; display: none; }
        #progress-bar { height: 100%; background: #007bff; width: 0%; transition: width 0.3s; }
        a { display: block; margin-top: 10px; color: #007bff; text-decoration: none; }
    </style>
</head>
<body>
    <h1>M3U8 转 MP4 在线转换器</h1>
    <p>输入 M3U8 URL（确保支持 CORS），点击转换。首次加载 FFmpeg 可能需 10-30s。</p>
    <input type="url" id="m3u8Url" placeholder="例如: https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8" required>
    <br><br>
    <button id="convertBtn">开始转换</button>
    <div id="progress">
        <div id="progress-bar"></div>
    </div>
    <p id="status">就绪 - 支持浏览器端转换，无需上传文件</p>
    <a id="downloadLink" style="display: none;">下载 MP4 文件</a>

    <script>
        let ffmpeg = null;
        const statusEl = document.getElementById('status');
        const convertBtn = document.getElementById('convertBtn');
        const downloadLink = document.getElementById('downloadLink');
        const m3u8UrlEl = document.getElementById('m3u8Url');
        const progressEl = document.getElementById('progress');
        const progressBarEl = document.getElementById('progress-bar');

        // 检查 FFmpeg 是否加载（延长超时到 10s）
        function waitForFFmpeg() {
            return new Promise((resolve, reject) => {
                const maxAttempts = 100;  // 10s 超时（100ms * 100）
                let attempts = 0;
                const interval = setInterval(() => {
                    attempts++;
                    if (typeof FFmpeg !== 'undefined') {
                        clearInterval(interval);
                        resolve(FFmpeg);
                    } else if (attempts >= maxAttempts) {
                        clearInterval(interval);
                        reject(new Error('FFmpeg 脚本加载失败 - 检查网络或代理'));
                    }
                }, 100);
            });
        }

        async function loadFFmpeg() {
            if (ffmpeg) return ffmpeg;

            try {
                // 等待 FFmpeg 定义
                const FFmpegLib = await waitForFFmpeg();
                const { createFFmpeg, fetchFile } = FFmpegLib;

                statusEl.textContent = '正在初始化 FFmpeg WASM（可能需 10-30s）...';
                ffmpeg = createFFmpeg({ 
                    log: true, 
                    mainName: 'main'  // 单线程模式
                });
                await Promise.race([
                    ffmpeg.load({
                        coreURL: '/wasm/@ffmpeg/core@0.12.6/dist/umd/ffmpeg-core.js',  // 通过代理
                        wasmURL: '/wasm/@ffmpeg/core@0.12.6/dist/umd/ffmpeg-core.wasm'   // 通过代理
                    }),
                    new Promise((_, reject) => setTimeout(() => reject(new Error('加载超时（30s）')), 30000))
                ]);
                statusEl.textContent = 'FFmpeg 加载完成！';
                return ffmpeg;
            } catch (error) {
                console.error('FFmpeg 加载失败:', error);
                statusEl.textContent = `加载失败: ${error.message} - 检查控制台日志`;
                ffmpeg = null;
                throw error;
            }
        }

        convertBtn.addEventListener('click', async () => {
            const m3u8Url = m3u8UrlEl.value.trim();
            if (!m3u8Url) {
                alert('请输入有效的 M3U8 URL');
                return;
            }

            convertBtn.disabled = true;
            progressEl.style.display = 'block';
            progressBarEl.style.width = '0%';
            downloadLink.style.display = 'none';

            try {
                await loadFFmpeg();
                statusEl.textContent = '下载视频流...';

                const response = await fetch(m3u8Url);
                if (!response.ok) {
                    throw new Error(`HTTP 错误: ${response.status} - 检查 URL 是否有效`);
                }
                const data = await response.arrayBuffer();
                await ffmpeg.FS('writeFile', 'input.m3u8', await fetchFile(new Uint8Array(data)));

                statusEl.textContent = '转换中...';
                await ffmpeg.run(['-i', 'input.m3u8', '-c', 'copy', '-bsf:a', 'aac_adtstoasc', 'output.mp4']);

                const fileData = await ffmpeg.FS('readFile', 'output.mp4');
                const blob = new Blob([fileData.buffer], { type: 'video/mp4' });
                const url = URL.createObjectURL(blob);

                downloadLink.href = url;
                downloadLink.download = `converted-${Date.now()}.mp4`;
                downloadLink.textContent = '点击下载 MP4 文件';
                downloadLink.style.display = 'block';
                statusEl.textContent = '转换完成！';

            } catch (error) {
                let errorMsg = error.message;
                if (errorMsg.includes('CORS')) {
                    errorMsg += ' - 尝试使用支持 CORS 的代理或检查源站设置。';
                } else if (errorMsg.includes('fetch')) {
                    errorMsg += ' - 检查网络连接或 URL 访问权限。';
                }
                statusEl.textContent = `转换失败: ${errorMsg}`;
                console.error(error);
            } finally {
                convertBtn.disabled = false;
                progressEl.style.display = 'none';
            }
        });
    </script>
</body>
</html>
